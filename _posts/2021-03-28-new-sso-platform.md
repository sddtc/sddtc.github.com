---
title: "从零开始解决企业多用户身份现状"
layout: post
categories: tech oauth
date: "2021-03-28"
guid: urn:uuid:f2f1bb31-ee56-4fc2-b1c7-4fc848ed4df9
tags:
  - OAuth2
  - SSO
  - consult
---

企业 A 有一个面向普通用户的大型在线网站，日增用户大概是 5000，网站支持匿名用户搜索心仪的房产并进行查看和联系中介商，或通过注册登陆来完成一些定制化的需求，  
比如填写申请住房信息并申请租房，或者是对自己正在出售的房屋进行数据观测，网站提供了丰富的分析数据来帮助卖家分析行情。  

而今天我们想要分享的是这个用户的登录系统涅槃重生的小故事。  
在大家的印象里，登陆系统长什么样子？  

![2021-03-28-dNhv3d-1](https://cdn.jsdelivr.net/gh/sddtc/upic-cloud@main/images/2021/2021-03-28-dNhv3d-1.png)

##### 而登陆系统的背后往往是:
* 将用户名和密码加密存储在数据库的用户登陆表里
* 用户登陆的表还会存储一些有时效性的令牌，例如，处理找回密码等需求
* 用户登陆的表可能还会有一些用户画像字段，例如，昵称，性别，生日
* 用户登陆的表可能还会有一些标识位字段，例如，账号是否有效，账号是否被删除，账号是否是黑名单用户
* 用户登陆的表可能还会有一些第三方登陆相关的字段

![2021-03-28-ohkXo6-2](https://cdn.jsdelivr.net/gh/sddtc/upic-cloud@main/images/2021/2021-03-28-ohkXo6-2.png)

闻到了吗？一些设计上的味道。  
* 用户身份验证信息(邮箱地址，密码) 和用户画像信息(性别，年龄，生日)耦合
* 用户权限(黑名单，是否有效)信息渗透到用户表中
* 扩展性不佳，用户表需要关心网站集成的所有第三方登陆客户端

小小的用户登陆系统有着大大的复杂性。随着商业的发展，业务的激增，对于用户管理的需求也会在有限的交付中迅速扩张，导致登陆系统的可用性和扩展性都面临着挑战。  

而企业 A 的旧登陆系统也逃不出要被新登陆系统取代的宿命，这句话不是针对这个旧系统，而是针对所有有了设计坏味道并且想要寻求改变的存在，在加上一点点因为安全因素的成分:   
#### 一，一个失效日期长达 68 年的令牌: `LXXXTOK`
该令牌一开始就背负着极为丰富的使命，在漫漫时间长河中已经被多达 72 个子系统使用：  
* 跟踪匿名用户的行为
* 确定用户 "已登陆" 状态
* 用于检索该已登陆用户的电子邮件地址

一些缺陷：  
* 失效日期长达 68 年。 试想一下，用户使用一个公共电脑登陆了自己的账户并且忘记退出，而这个 `LXXXTOK` 被别有用心的人得到后，可能会拥有获取该用户在对应网站基本个人信息的 "强大" 能力
* 令牌可以被网站其它 JavaScript 脚本获取

#### 二，企业快速扩张，收购其他公司之后引入了多用户身份，从长远角度来看阻碍了用户画像的绘制

![2021-03-28-4ECDFQ-3](https://cdn.jsdelivr.net/gh/sddtc/upic-cloud@main/images/2021/2021-03-28-4ECDFQ-3.png)

#### 三，旧登陆系统没有 `SNS` 集成的能力，而 `Facebook` 一直是企业用户导流的战略中重要的一环

基于以上三点，还有一些可能我不知道的原因，新登录系统准备诞生了 ：）  

##### 那么新登录系统需要有什么特点呢 ?
* 有当前业界权威的标准做背书。例如，OAuth2 & OIDC
* 能天然的支持引入 SNS 平台的第三方登陆。例如，Facebook, Apple..
* 支持 MFA，更安全的保护用户的信息。
* 成本的经济性考虑，负载弹性扩容

那么基于企业 A 和 `AWS` 深度集成的现状，我们使用了 `AWS Cognito` 作为基础服务。  

如果故事的结局只是将用户登录系统替换为一个基于 `OAuth2.0` 协议的 `SSO` 系统并且还有 `PKCE` 加成再集成了第三方登录那么故事到这里应该就是 happy ending 了。    

还有一点时间，让我们一起品品新登录系统的迷人之处吧 ：）  

### 一，Serverless 技术架构
企业 A 采用 OAuth2 的 code flow 进行身份认证的授权  

![2021-03-28-Zu4ef2-4](https://cdn.jsdelivr.net/gh/sddtc/upic-cloud@main/images/2021/2021-03-28-Zu4ef2-4.png)
[图片来源](https://tools.ietf.org/html/rfc6749#section-4.1)

而项目的架构主要采用 `AWS API Gateway` + `Lambda` + `AWS Cognito`  

![2021-03-28-GGvqu7-5](https://cdn.jsdelivr.net/gh/sddtc/upic-cloud@main/images/2021/2021-03-28-GGvqu7-5.png)

#### 什么是 AWS Cognito ?
`AWS` 的 `Cognito` 服务为 `Web` 和移动应用提供了身份验证，授权和用户管理功能。  
使我们的用户可以使用用户名 + 密码直接登录，也可以通过第三方（例如 `Facebook`、`Okta`、`Google` 或 `Apple`）登录。  

`AWS Cognito` 支持使用 `lambda` 函数来构建符合企业特定需求的登陆系统，其中 `lambda` 函数(也称作触发器)包括：  

* 注册新用户之前触发。例如，执行自定义的验证
* 确认新用户后触发。 例如，收集新的用户数据
* 当用户尝试登陆时触发。例如，可以在这个函数中定义特殊的逻辑来接受或拒绝用户的身份验证请求
* 在登陆用户后被触发。例如，发送邮件通知用户你的账号在几点几分在某设备上登陆，如有疑问请与网站进行联系
* 自定义身份验证流程触发器
* 令牌生成之前会被触发。例如，允许在生成身份令牌之前自定义身份令牌。可以使用此函数在身份令牌中添加新声明、更新声明或者隐藏声明。
* 迁移用户时触发。例如，用户在尝试使用密码登录时，或在使用忘记密码流程时未在用户池中，则可以触发该函数
* 在发送电子邮件或电话验证消息或多重验证 (MFA) 代码前被触发。可以动态的自定义消息

#### 什么是 UserPool ?
`UserPool` 是 `AWS Cognito` 的两个主要组件之一：用户池。  
为网站和应用程序提供用户信息的存储和检索功能。  
企业 A 存储了用户的登陆邮箱地址和密码等最基本的登陆相关的信息。而将用户画像的信息下放到各个子系统进行定制化维护。  

### 二，更加安全
#### MFA(多因子验证)
多因子身份验证是一种安全系统。  
即用户需要通过两种以上的认证机制才能得到授权访问资源服务器的资源。 例如，邮箱登陆 + 手机号验证码，邮箱登陆 + `TOTP` 软件令牌。使用 `MFA` 可以很好的保证用户信息的安全。

#### PKCE (Proof Key for Code Exchange)
`PKCE` 是基于客户端的安全实践。即在手机应用里也能安全的保证用户身份授权。  
手机应用一般是指没有后端服务器，所有代码都在用户本地设备上运行的软件（如 `Windows/Mac` 客户端或者 `iOS/Android` 客户端)，因此想让手机应用安全存放密钥是不现实的，容易被破解。
而 `PKCE` 是通过一种密码学手段确保恶意第三方即使截获 `Authorization Code` 或者其他密钥，也无法向认证服务器交换 `Access Token` 的标准。  

这两种安全的标准全部在企业 A 的新登陆系统中进行了实现，保证了用户信息的安全，使系统的健康程度更上了一层。  

### 总结之上线之夜
在旧登陆系统逐一击破对 `LXXXTOK` 的依赖，那么依然会迎来一个待解决问题： 选一个日子将新的登陆系统上线，需要保证：  
* 曾经登陆过网站并用户身份还没有过期，依然会被引导到新登录系统的登陆页面，使用用户名 + 旧密码 重新登陆。验证用户名和旧密码都正确之后，新登录系统会再次将用户引导到忘记密码页面，强制用户更新密码。淘汰旧登陆系统的密码。
* 新注册的用户， 则直接使用新登陆系统的注册页面进行注册。
* 很久没有登陆过网站的 "睡眠" 用户，在上线前发送邮件，提供给用户新的登陆系统的入口，企图唤醒部分 "睡眠" 用户

##### 事到如今，回想起上线的那个晚上依然使我热血澎湃。  
因为新登录系统有太多相对于旧系统的突破：  
* 在新登录系统上云之后，我们利用了 AWS 的生态，集成了相关服务，轻松的构建出产品关心的更清晰的用户行为数据。
* 使用 `Severless` 架构，体会到根据请求量，用户量弹性收费的甜头。在交付过程中更加兴奋和高效。~~我必须要说，JS 是世界上最好的语言!~~
* 用户登陆页面风格统一，且可以根据不同的子系统的特殊需求定义出多语言，多主题，不同的第三方登陆体验
* 实现了统一用户画像，企业 A 的身份生态高度统一。一个 uuid 代表一个唯一的用户，通过这个 uuid 能更加了解到用户喜欢使用企业的哪些系统，为未来的产品路线提供更多的可能性。
* 对于全球企业来说，在每个国家和地区拥有自己的网站也不足为奇，那么不同地区对于用户信息有不同安全级别的法律要求。AWS 的多 region 同样能保证企业 A 在法律方面的限制，为他们部署出不同地区的 AWS Cognito 服务

##### 然而万物都是多面的，有阳光的一面，就有因为树叶遮盖而产生的阴影的一面，新的登陆系统也同样如此：  
* 不够完备的开发体验，导致本地无法搭建端到端测试环境。进行关键的更改容易被束手束脚
* 在统一 30+ 个不同的身份系统的过程中，我们一直在遇到和尝试解决各种问题：
  * "用户能不能更改自己作为登陆凭证的邮箱地址，如果可以，我们需要记录新旧邮箱地址吗，如何避免新邮箱已经存在的现状，该怎么保证这两个邮箱都是用户本人的邮箱？"
  * "同时从两个子系统来过的用户，我们应该优先集成哪个来源？"
  * "如何合并用户用自己的邮箱注册的账号和用户使用谷歌账号登陆的账号？"
  * "Apple 的账号系统支持用户选择隐藏自己的邮箱，那么我们该怎么识别这些用户账号的背后其实都是一个人？" 
* 该怎么做灾备？ 该怎么在真实环境下切换一整套登陆系统到 AWS 新的地区的登陆系统?

### 后记
不断的追求技术的最优解，追求符合业务模型的最优解是我在这次经历中感受很深的事。  
虽然还有很多未知的难题等着我们解决，作为程序员，抱着 “技术改变世界” 的热情，一定会创造出更多价值。
